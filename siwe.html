<!DOCTYPE html>
<html>
<head>
  <title>Sign-In with Ethereum Example</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.5.umd.min.js" type="application/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/siwe/dist/siwe.umd.js"></script>
  <script>
    // Initialize the SIWE library
    const siwe = new SIWE();

    // Connect to the user's wallet
    async function connectWallet() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const signer = provider.getSigner();
          const address = await signer.getAddress();
          document.getElementById("address").innerHTML = address;
        } catch (error) {
          console.error(error);
        }
      } else {
        alert("Please install MetaMask or another compatible wallet.");
      }
    }

    // Sign in with Ethereum
    async function signInWithEthereum() {
      if (window.ethereum) {
        try {
          // Generate a SIWE message with the domain name and a nonce
          const domain = "agentjacker.github.io";
          const nonce = Math.random().toString(36).substring(2, 15);
          const message = siwe.createMessage(domain, nonce);

          // Request the user to sign the message with their wallet
          const signature = await window.ethereum.request({
            method: 'personal_sign',
            params: [message, window.ethereum.selectedAddress],
          });

          // Verify the signature and extract the address
          const address = siwe.verifyMessage(message, signature);

          // Send the address, message, signature, and nonce to the backend for authentication
          const response = await fetch("/auth", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              address,
              message,
              signature,
              nonce,
            }),
          });

          // Handle the response from the backend
          if (response.ok) {
            // The user is successfully authenticated
            alert("You are signed in!");
          } else {
            // The authentication failed
            alert("Something went wrong.");
          }
        } catch (error) {
          console.error(error);
        }
      } else {
        alert("Please connect your wallet first.");
      }
    }
  </script>
</head>
<body>
  <h1>Sign-In with Ethereum Example</h1>
  <p>Your address: <span id="address">-</span></p>
  <button onclick="connectWallet()">Connect Wallet</button>
  <button onclick="signInWithEthereum()">Sign In with Ethereum</button>
</body>
</html>
